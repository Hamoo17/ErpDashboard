@using ErpDashboard.Application.Models;
@using ErpDashboard.Client.Infrastructure.Managers.Customers;
@using ErpDashboard.Application.Features.Customer.Command.AddEdit;
@using ErpDashboard.Application.Features.Customer.Quers.GetAllCustomers;
@using ErpDashboard.Application.Features.Customer.Quers.GetAllAreas;
@using ErpDashboard.Application.Features.Customer.Quers.GetAllBranches;
@inject ICustomersManager _CustomerManger;
<EditForm Model="Model">
	<MudDialog>
		<DialogContent>
			<MudCard Style="margin-bottom:30px">
				<MudCardHeader>
					<MudIcon Style=" color:darkorange;font-size:3rem;padding-bottom:10px" Icon="@Icons.Filled.LocationOn"></MudIcon>
					<HeroTitle Title="Customer Adress"></HeroTitle>
				</MudCardHeader>
				<MudCardContent>
					<MudGrid>
						<MudItem md="6" sm="12" xs="12">
							<MudTextField For="@(() => Model.Adress)" @bind-Value="Model.Adress" Label="Adress" Variant="Variant.Outlined" />
						</MudItem>
						<MudItem md="6" sm="12" xs="12" >
							<MudAutocomplete Label="Area" Clearable="true" Variant="Variant.Outlined"  @bind-Value="Model.AreaId" For="@(() => Model.AreaId)"  ToStringFunc="@(e=> e==null ? "" : $"{AreasList.FirstOrDefault(x => x.Id == e).BranchName} | {AreasList.FirstOrDefault(x => x.Id == e).Name}")" SearchFunc="@Search1" ></MudAutocomplete>
						</MudItem>
					</MudGrid>
				</MudCardContent>
				<MudCardActions>
					<MudButton FullWidth="true" OnClick="Save" Variant="Variant.Filled" Style="margin-bottom:25px; height:50px; background-color:green;border-radius:7px;color:white">Save</MudButton>
				</MudCardActions>
			</MudCard>
		</DialogContent>
	</MudDialog>

</EditForm>


@code {
	[Parameter] public AdressDto Model { get; set; } = new();
	[CascadingParameter] MudDialogInstance MudDialog { get; set; }
	private List<GetAllAreaViewModal> AreasList { get; set; } = new();
	private List<BranchesDto> BranchiesList { get; set; } = new();
	private MudTable<GetAllAreaViewModal> _table;
	string _searchString = "";
	private int SelectedArea;
	private string searchString1 = "";
	private GetAllAreaViewModal selectedItem1 = null;
	private HashSet<GetAllAreaViewModal> selectedItems = new HashSet<GetAllAreaViewModal>();
	private IEnumerable<GetAllAreaViewModal> Elements = new List<GetAllAreaViewModal>();
	protected override async Task OnInitializedAsync()
	{
		await LoadAreas();
		await LoadBrancies();
	}
	private void Save()
	{
		MudDialog.Close(Model);
	}
	private async Task<IEnumerable<int>> Search1(string value)
	{

		if (string.IsNullOrEmpty(value))
		return  AreasList.Select(x=>x.Id);
		 
		return AreasList.Where(x => x.Name.Contains(value, StringComparison.InvariantCultureIgnoreCase) || x.BranchName.Contains(value,StringComparison.InvariantCultureIgnoreCase)).Select(x=>x.Id);
    }
	private bool FilterFunc1(GetAllAreaViewModal element) => FilterFunc(element, searchString1);
    private bool FilterFunc(GetAllAreaViewModal element, string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;
        if (element.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        return false;
    }

	private async Task LoadAreas()
	{
		var Response = await _CustomerManger.GetAllAreasAsync();
		if (Response.Succeeded)
		{
			AreasList = Response.Data;
		}
		else
		{
			foreach (var msg in Response.Messages)
			{
				_snackBar.Add(msg, Severity.Error);
			}

		}
	}
	private async Task LoadBrancies()
	{
		var Response = await _CustomerManger.GetAllBranchiesAsync();
		if (Response.Succeeded)
		{
			BranchiesList = Response.Data;
		}
		else
		{
			foreach (var msg in Response.Messages)
			{
				_snackBar.Add(msg, Severity.Error);
			}

		}

	}

	private void OnSearch(string text)
	{
		_searchString = text;
		_table.ReloadServerData();
	}

	}