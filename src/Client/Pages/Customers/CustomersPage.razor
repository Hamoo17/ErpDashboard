@page "/customers";
@using Client.Infrastructure.Managers.Customers;
@using ErpDashboard.Application.Features.Customer.Command.AddEdit
@using ErpDashboard.Application.Features.Customer.GetAllCustomers;
@inject ICustomersManager _CustomerManager;

<style>
	th {
		color: mediumvioletred !important;
		font-weight: bold !important;
	}
</style>

<MudAppBar Style="position:sticky;top:64px;background-color:white!important" Color="Color.Transparent" Fixed="false" Class="mb-4">
	<MudIcon Size=Size.Large Color=Color.Tertiary Class="mr-4" Icon="@Icons.Material.Filled.AccountCircle"></MudIcon>
	<HeroTitle Title=Customers></HeroTitle>
	<MudSpacer></MudSpacer>
	<MudFab StartIcon="@Icons.Filled.Add" Label="Add New Customer" Color=Color.Success OnClick="(() => InvokeModal(0))" />
</MudAppBar>

<MudTable Items="@Customers" @ref="_table" Hover="true" Breakpoint="Breakpoint.Sm" ServerData="@(new Func<TableState, Task<TableData<GetAllCustomerViewModal>>>(ServerReload))" Loading=@_Loading LoadingProgressColor=Color.Success Dense=true Class="mt-4">
	<ToolBarContent>
		<MudSpacer />
		<MudTextField T="string" ValueChanged="@(s=>OnSearch(s))" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"Variant="Variant.Outlined"></MudTextField>

	</ToolBarContent>
	<ColGroup>
		<col />
		<col style="width: 1px;" />
		<col />
		<col />
		<col />
		<col />
		<col />
		<col />
		<col />
	</ColGroup>
	<HeaderContent>
		<MudTh Style="color:red">Avatar</MudTh>
		<MudTh Style="color:red" Class="mySize"><MudTableSortLabel T="GetAllCustomerViewModal" SortLabel="Id">ID</MudTableSortLabel></MudTh>
		<MudTh><MudTableSortLabel T="GetAllCustomerViewModal" SortLabel="CustomerName">Name</MudTableSortLabel></MudTh>
		<MudTh> Phones</MudTh>
		<MudTh> Adress</MudTh>
		<MudTh>Category</MudTh>
		<MudTh>Reg date</MudTh>
		<MudTh>Status</MudTh>
		<MudTh>Actions</MudTh>
	</HeaderContent>

	<RowTemplate>
		<MudTd><MudAvatar Color="Color.Tertiary">@context.CustomerName.Substring(0,1)</MudAvatar></MudTd>
		<MudTd Class="mySize" DataLabel="Nr">@context.CustomerId</MudTd>
		<MudTd DataLabel="Sign">@context.CustomerName</MudTd>
		<MudTd DataLabel="Name">@context.CustomerPhone</MudTd>
		<MudTd DataLabel="Name">@context.Adress</MudTd>
		<MudTd DataLabel="Name">@context.Category</MudTd>
		<MudTd DataLabel="Name">@context.RegDate</MudTd>

		<MudTd>
			<MudSwitch @bind-Checked=@context.Status ReadOnly="true" Color="Color.Tertiary" />
		</MudTd>

		<MudTd>
			<MudButton Variant="Variant.Filled" Color="Color.Info" OnClick="(() => InvokeModal(context.id))">Edit </MudButton>
			<MudButton Variant="Variant.Filled" Color="Color.Error"OnClick="(()=>Delete(context.id))"  >Delete</MudButton>
		</MudTd>
	</RowTemplate>
	<PagerContent>
		<TablePager />
	</PagerContent>
</MudTable> 
@code {
	private IEnumerable<GetAllCustomerViewModal> Customers;
	private GetAllCustomerViewModal _customer;
	private MudTable<GetAllCustomerViewModal> _table;
	string _searchString = "";
	private bool _Loading;
	int SelectedCategory;
	private int _totalItems;
	private int _currentPage;
	protected override async Task OnInitializedAsync()
	{

	}

	private async Task<TableData<GetAllCustomerViewModal>> ServerReload(TableState state)
	{
		if (!string.IsNullOrWhiteSpace(_searchString))
		{
			state.Page = 0;
		}
		await Getdata(state.Page, state.PageSize, state);
		return new TableData<GetAllCustomerViewModal> { TotalItems = _totalItems, Items = Customers };
	}
	private async Task Getdata(int pageNumber, int pageSize, TableState state)
	{
		string[] orderings = null;
		if (!string.IsNullOrEmpty(state.SortLabel))
		{
			orderings = state.SortDirection != SortDirection.None ? new[] { $"{state.SortLabel} {state.SortDirection}" } : new[] { $"{state.SortLabel}" };
		}
		if (orderings == null)
		{
			orderings = new string[1];
			orderings[0] = "ID";
		}
		var Request = new GetAllCustomersQuery() { PageSize = pageSize, PageNumber = pageNumber + 1, SearchString = _searchString, OrderBy = orderings };
		var response = await _CustomerManager.GetAllAsync(Request);
		if (response.Succeeded)
		{
			_totalItems = response.TotalCount;
			_currentPage = response.CurrentPage;
			Customers = response.Data;
		}
		else
		{
			foreach (var msg in response.Messages)
			{
				_snackBar.Add(msg, Severity.Error);
			}

		}
	}
	private void OnSearch(string text)
	{
		_searchString = text;
		_table.ReloadServerData();
	}
	private async Task InvokeModal(int id = 0)
	{
		var parameters = new DialogParameters();
		if (id != 0)
		{
			_customer = Customers.FirstOrDefault(c => c.id == id);
			if (_customer != null)
			{
				parameters.Add(nameof(AddEditCustomerPage.Model), new AddEditCustomerCommand
					{
						Id = _customer.id,
						CustomerId = _customer.CustomerId,
						CustomerName = _customer.CustomerName,
						Email = _customer.Email,
						CustomerType = _customer.CustomerType,
						RegType = _customer.RegType,
						Weight = _customer.Weight,
						Height = _customer.Height,
						Status = _customer.Status,
						Notes = _customer.Notes,
						CategoryId = _customer.CategoryId,
						BirthDate = _customer.BirthDate,
						customerAdresses = _customer.customerAdresses,
						customerPhons = _customer.customerPhons
					});
			}
		}
		var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Large, FullWidth = true, DisableBackdropClick = true };
		var dialog = _dialogService.Show<AddEditCustomerPage>(id == 0 ? "Create" : "Edit", parameters, options);
		var result = await dialog.Result;

			Reset();
		
	}
	private void Reset()
	{

		OnSearch("");
	}
	private async Task Delete(int id)
	{
		string deleteContent = "You Are Going To Delete the Plan Days";
		var parameters = new DialogParameters
			{
				{nameof(Shared.Dialogs.DeleteConfirmation.ContentText), string.Format(deleteContent, id)}
			};
		var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true, DisableBackdropClick = true };
		var dialog = _dialogService.Show<Shared.Dialogs.DeleteConfirmation>("Delete", parameters, options);
		var result = await dialog.Result;
		if (!result.Cancelled)
		{
			var response = await _CustomerManager.DeleteAsync(id);
			if (response.Succeeded)
			{
				_snackBar.Add(response.Messages[0], Severity.Success);
				Reset();
			}
			else
			{
				foreach (var message in response.Messages)
				{
					_snackBar.Add(message, Severity.Error);
				}
			}
		}
	}

}
